# 페이플 결제 시스템 ItHome 통합 가이드

## 개요
이 가이드는 페이플(Payple) 해외결제 API를 ItHome 숙박 예약 서비스에 통합하는 방법을 설명합니다. 현재 테스트 환경으로 구성되어 있어 실제 결제 없이 안전하게 테스트할 수 있습니다.

## 1. 환경 설정

### 백엔드 환경 변수 (.env)
```bash
# 페이플 결제 시스템 설정 (테스트 환경)
PAYPLE_SERVICE_ID=demo
PAYPLE_SERVICE_KEY=your_test_service_key_here
PAYPLE_API_BASE_URL=https://demo-api.payple.kr
PAYPLE_SCRIPT_URL=https://demo-gpay.payple.kr/common/js/gpay-1.0.1.js

# 서버 설정
CLIENT_HOSTNAME=http://localhost:3000
SERVER_HOSTNAME=http://localhost:3001

# 기존 ItHome 설정
NEXT_PUBLIC_BACKEND_URL=http://localhost:3000
DATABASE_URL="your_database_url"
JWT_SECRET="your_jwt_secret"
```

### 프론트엔드 환경 변수 (.env.local)
```bash
NEXT_PUBLIC_BACKEND_URL=http://localhost:3000
NEXT_PUBLIC_PAYPLE_SCRIPT_URL=https://demo-gpay.payple.kr/common/js/gpay-1.0.1.js
```

## 2. 백엔드 설정

### 의존성 추가
```bash
cd ItHome-Backend/backend
npm install @nestjs/axios rxjs
```

### 생성된 파일들:
1. `src/modules/payment/payment.module.ts` - 페이플 결제 모듈
2. `src/modules/payment/payment.service.ts` - 페이플 API 연동 서비스
3. `src/modules/payment/payment.controller.ts` - 결제 API 엔드포인트

### API 엔드포인트:
- `POST /payment/auth` - 페이플 인증 토큰 발급
- `POST /payment/billing-key` - 빌링키 결제
- `POST /payment/cancel` - 결제 취소
- `POST /payment/result` - 결제 결과 웹훅

## 3. 프론트엔드 설정

### 의존성 추가
```bash
cd ItHome-Front
npm install axios
```

### 생성된 컴포넌트:
1. `src/@shared/components/Payment/PayplePayment.tsx` - 페이플 결제 컴포넌트
2. `src/app/[locale]/reservation/payment/page.tsx` - 예약 결제 페이지

## 4. 사용 방법

### 예약에서 결제로 이동하는 예시:
```typescript
// 기존 예약 컴포넌트에서
const handleReservationSubmit = () => {
  const paymentUrl = `/reservation/payment?` + new URLSearchParams({
    postKey: postData.key.toString(),
    startDay: reservationData.startDay,
    endDay: reservationData.endDay,
    totalAmount: totalAmount.toString(),
    comments: `${postData.title} - 방 예약`,
  });
  
  router.push(paymentUrl);
};
```

### 결제 흐름:
1. 사용자가 예약 정보 입력
2. 결제 페이지로 이동
3. 결제자 정보 입력 (이름, 이메일)
4. 페이플 결제창 호출
5. 카드 정보 입력 및 결제
6. 결제 결과 처리

## 5. 테스트 방법

### 테스트 카드 정보:
```
카드번호: 4111111111111111 (Visa)
만료일: 12/25 (미래 날짜)
CVC: 123
카드소유주: Test User
```

### 테스트 시나리오:
1. 방 상세 페이지에서 예약 버튼 클릭
2. 예약 정보 입력 (날짜, 인원 등)
3. 결제 페이지로 이동
4. 결제자 정보 입력
5. "결제하기" 버튼 클릭
6. 페이플 결제창에서 테스트 카드 정보 입력
7. 결제 완료 확인

## 6. 주요 기능

### 일반 결제:
- 신용카드/직불카드 결제
- 팝업 또는 다이렉트 결제창
- 실시간 결제 결과 처리

### 빌링키 결제:
- 카드 정보 저장 후 간편 결제
- CVC 코드만으로 재결제
- 정기 결제 가능

### 결제 취소:
- 전액 취소
- 부분 취소 (향후 구현)
- 자동 환불 처리

## 7. 보안 고려사항

### 현재 테스트 환경:
- 실제 결제 발생하지 않음
- 테스트 카드만 사용 가능
- 개발/테스트 목적으로만 사용

### 운영 환경 적용 시:
1. `PAYPLE_API_BASE_URL`을 `https://api.payple.kr`로 변경
2. `PAYPLE_SCRIPT_URL`을 `https://gpay.payple.kr/common/js/gpay-1.0.1.js`로 변경
3. 실제 서비스 ID와 키 발급 받기
4. SSL 인증서 적용
5. 결제 로그 및 감사 기능 추가

## 8. 운영 환경 설정

### 페이플 파트너 등록:
1. [페이플 홈페이지](https://www.payple.kr) 방문
2. 파트너 가입 신청
3. 사업자 등록증 및 필요 서류 제출
4. 심사 완료 후 실제 서비스 ID/KEY 발급
5. White IP 등록 (서버 IP 주소)

### 환경 변수 변경:
```bash
# 운영 환경
PAYPLE_SERVICE_ID=your_real_service_id
PAYPLE_SERVICE_KEY=your_real_service_key
PAYPLE_API_BASE_URL=https://api.payple.kr
PAYPLE_SCRIPT_URL=https://gpay.payple.kr/common/js/gpay-1.0.1.js
```

## 9. 문제 해결

### 자주 발생하는 오류:
1. **인증 토큰 발급 실패**: SERVICE_ID, SERVICE_KEY 확인
2. **결제창 호출 실패**: 스크립트 로드 확인
3. **결제 결과 수신 실패**: resultUrl 경로 확인
4. **CORS 오류**: 백엔드 CORS 설정 확인

### 로그 확인:
- 백엔드: NestJS 로그 출력
- 프론트엔드: 브라우저 개발자 도구 콘솔
- 페이플: 파트너 센터 결제 내역

## 10. 추가 기능 구현 예정

1. 결제 내역 관리
2. 환불 신청 기능
3. 정기 결제 (월세 등)
4. 다국가 통화 지원
5. 모바일 앱 연동

## 결론

페이플 결제 시스템이 성공적으로 통합되었습니다. 현재 테스트 환경에서 안전하게 결제 플로우를 테스트할 수 있으며, 실제 서비스 적용 시 환경 변수만 변경하면 됩니다. 

궁금한 사항이나 추가 기능이 필요하시면 언제든 말씀해 주세요! 